stages:
  - pre-build
  - test
  - build
  - deploy
  - staging
  - sanity
  - release

before_script:
  - export BUILD_VERSION=${BUILD_VERSION_INIT}.${CI_BUILD_REF:0:8}
  - echo $BUILD_VERSION
  - export WEB_PKG_NAME="wu-fe-apps-web-${BUILD_VERSION}.zip"
  - echo $WEB_PKG_NAME

npm:install:
  stage: pre-build
  cache:
    key: $CI_COMMIT_SHA
    paths:
      - node_modules
  script:
    - PACKAGE_JSON_HASH=($(md5sum package.json))
    - NG6_NODE_MODULES_CACHE=${CI_CACHE_DIR}/ng6_node_modules_${PACKAGE_JSON_HASH}.tar.gz
    - >
      if [ -f $NG6_NODE_MODULES_CACHE ];
      then
        echo 'No change in package.json, extracting cached node_modules.'
        tar zxf $NG6_NODE_MODULES_CACHE;
      else
        echo 'Change in package.json, installing packages and caching it.'
        npm cache clean --force
        npm install
        npm run webdriver-update
        tar zcf - ./node_modules > $NG6_NODE_MODULES_CACHE;
      fi
